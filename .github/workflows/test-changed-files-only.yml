name: Test Changed Files Only Feature

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  actions: read

jobs:
  scan-all-files:
    name: ðŸ“Š Scan All Files (Baseline)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli@latest

      - name: Install Code Analyzer Plugin
        run: sf plugins install code-analyzer@latest

      - name: Run Code Analyzer - All Files
        id: analyze-all
        uses: forcedotcom/run-code-analyzer@ng-pr-changes
        with:
          run-arguments: --workspace ./existing-code --output-file results-all.json
          results-artifact-name: all-files-results
          github-token: ${{ github.token }}
          changed-files-only: false

      - name: ðŸ“ˆ Display All Files Results
        run: |
          echo "## ðŸ“Š All Files Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This scan analyzes **ALL files** in the repository, including pre-existing code." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Total Violations** | ${{ steps.analyze-all.outputs.num-violations }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Critical (Sev 1) | ${{ steps.analyze-all.outputs.num-sev1-violations }} |" >> $GITHUB_STEP_SUMMARY
          echo "| High (Sev 2) | ${{ steps.analyze-all.outputs.num-sev2-violations }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Medium (Sev 3) | ${{ steps.analyze-all.outputs.num-sev3-violations }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Low (Sev 4) | ${{ steps.analyze-all.outputs.num-sev4-violations }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Info (Sev 5) | ${{ steps.analyze-all.outputs.num-sev5-violations }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Exit Code: \`${{ steps.analyze-all.outputs.exit-code }}\`" >> $GITHUB_STEP_SUMMARY

  scan-changed-files-only:
    name: ðŸŽ¯ Scan Changed Files Only
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli@latest

      - name: Install Code Analyzer Plugin
        run: sf plugins install code-analyzer@latest

      - name: Run Code Analyzer - Changed Files Only
        id: analyze-changed
        uses: forcedotcom/run-code-analyzer@ng-pr-changes
        with:
          run-arguments: --workspace ./existing-code --output-file results-changed.json
          results-artifact-name: changed-files-results
          github-token: ${{ github.token }}
          changed-files-only: true

      - name: ðŸŽ¯ Display Changed Files Results
        run: |
          echo "## ðŸŽ¯ Changed Files Only Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This scan analyzes **ONLY files changed** in this pull request." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Total Violations** | ${{ steps.analyze-changed.outputs.num-violations }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Critical (Sev 1) | ${{ steps.analyze-changed.outputs.num-sev1-violations }} |" >> $GITHUB_STEP_SUMMARY
          echo "| High (Sev 2) | ${{ steps.analyze-changed.outputs.num-sev2-violations }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Medium (Sev 3) | ${{ steps.analyze-changed.outputs.num-sev3-violations }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Low (Sev 4) | ${{ steps.analyze-changed.outputs.num-sev4-violations }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Info (Sev 5) | ${{ steps.analyze-changed.outputs.num-sev5-violations }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Exit Code: \`${{ steps.analyze-changed.outputs.exit-code }}\`" >> $GITHUB_STEP_SUMMARY

  compare-results:
    name: ðŸ“ˆ Compare Both Modes
    runs-on: ubuntu-latest
    needs: [scan-all-files, scan-changed-files-only]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli@latest

      - name: Install Code Analyzer Plugin
        run: sf plugins install code-analyzer@latest

      - name: Scan All Files
        id: all
        uses: forcedotcom/run-code-analyzer@ng-pr-changes
        with:
          run-arguments: --workspace ./existing-code --output-file all.json
          results-artifact-name: comparison-all-files-results
          github-token: ${{ github.token }}
          changed-files-only: false

      - name: Scan Changed Files
        id: changed
        uses: forcedotcom/run-code-analyzer@ng-pr-changes
        with:
          run-arguments: --workspace ./existing-code --output-file changed.json
          results-artifact-name: comparison-changed-files-results
          github-token: ${{ github.token }}
          changed-files-only: true

      - name: ðŸ“Š Create Comparison Summary
        run: |
          echo "## ðŸ“ˆ Side-by-Side Comparison" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | All Files | Changed Files Only | Difference |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-----------|-------------------|------------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | ${{ steps.all.outputs.num-violations }} | ${{ steps.changed.outputs.num-violations }} | $(( ${{ steps.all.outputs.num-violations }} - ${{ steps.changed.outputs.num-violations }} )) |" >> $GITHUB_STEP_SUMMARY
          echo "| Critical (Sev 1) | ${{ steps.all.outputs.num-sev1-violations }} | ${{ steps.changed.outputs.num-sev1-violations }} | $(( ${{ steps.all.outputs.num-sev1-violations }} - ${{ steps.changed.outputs.num-sev1-violations }} )) |" >> $GITHUB_STEP_SUMMARY
          echo "| High (Sev 2) | ${{ steps.all.outputs.num-sev2-violations }} | ${{ steps.changed.outputs.num-sev2-violations }} | $(( ${{ steps.all.outputs.num-sev2-violations }} - ${{ steps.changed.outputs.num-sev2-violations }} )) |" >> $GITHUB_STEP_SUMMARY
          echo "| Medium (Sev 3) | ${{ steps.all.outputs.num-sev3-violations }} | ${{ steps.changed.outputs.num-sev3-violations }} | $(( ${{ steps.all.outputs.num-sev3-violations }} - ${{ steps.changed.outputs.num-sev3-violations }} )) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’¡ Interpretation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **All Files:** Total violations across the entire codebase" >> $GITHUB_STEP_SUMMARY
          echo "- **Changed Files Only:** Violations only in files modified by this PR" >> $GITHUB_STEP_SUMMARY
          echo "- **Difference:** Violations in unchanged/legacy code (not your responsibility!)" >> $GITHUB_STEP_SUMMARY

  quality-gate-demo:
    name: âœ… Quality Gate Demo
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli@latest

      - name: Install Code Analyzer Plugin
        run: sf plugins install code-analyzer@latest

      - name: Run Analysis
        id: analyze
        uses: forcedotcom/run-code-analyzer@ng-pr-changes
        with:
          run-arguments: --workspace ./existing-code --output-file results.json
          results-artifact-name: quality-gate-results
          github-token: ${{ github.token }}
          changed-files-only: true

      - name: âœ… Quality Gate Check
        id: gate
        run: |
          VIOLATIONS=${{ steps.analyze.outputs.num-violations }}
          SEV1=${{ steps.analyze.outputs.num-sev1-violations }}
          SEV2=${{ steps.analyze.outputs.num-sev2-violations }}
          
          echo "## ðŸš¦ Quality Gate Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$SEV1" -gt 0 ] || [ "$SEV2" -gt 0 ]; then
            echo "### âŒ Quality Gate: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Reason:** Found critical or high severity violations in changed files" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Severity | Count | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| Critical (Sev 1) | $SEV1 | âŒ |" >> $GITHUB_STEP_SUMMARY
            echo "| High (Sev 2) | $SEV2 | âŒ |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> âš ï¸ In a real workflow, this would fail the build with \`exit 1\`" >> $GITHUB_STEP_SUMMARY
            echo "> For demo purposes, we're just showing the failure without blocking." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… Quality Gate: PASSED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No critical or high severity violations found in changed files!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Critical (Sev 1) | $SEV1 âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| High (Sev 2) | $SEV2 âœ… |" >> $GITHUB_STEP_SUMMARY
            echo "| Total Violations | $VIOLATIONS |" >> $GITHUB_STEP_SUMMARY
          fi

